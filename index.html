<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Mind Garden CSV</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root {
  --bg: #020617; --card: #0f172a; --muted: #94a3b8;
  --g1: #dcfce7; --g2: #86efac; --g3: #22c55e; --g4: #15803d;
  --today: #38bdf8;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
  margin: 0; font-family: -apple-system, system-ui, sans-serif; 
  background: #020617; color: #fff; 
  padding: env(safe-area-inset-top) 1rem env(safe-area-inset-bottom);
}
main { max-width: 500px; margin: auto; padding-top: 1rem; }

/* UI Box Container */
.control-panel {
  background: #1e293b;
  border-radius: 20px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  border: 1px solid #334155;
}
.input-group { display: flex; gap: 8px; margin-bottom: 12px; }
.date-row { 
  display: flex; align-items: center; justify-content: space-between; 
  background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 12px;
}

input, textarea, button { 
  background: #0f172a; border: 1px solid #334155; border-radius: 12px; 
  color: #fff; padding: 12px; font-size: 16px;
}
input[type="date"] { background: transparent; border: none; padding: 0; color-scheme: dark; }
#habitInput { flex: 1; }
button { cursor: pointer; font-weight: 600; }
.btn-primary { background: var(--g3); color: #020617; border: none; }
.btn-outline { background: transparent; border: 1px solid #334155; font-size: 0.8rem; }

.card { background: var(--card); border-radius: 20px; padding: 1.2rem; margin-bottom: 1rem; border: 1px solid #1f2937; }
.habit { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #1f2937; }
.check { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--g3); display: flex; align-items: center; justify-content: center; }
.check.done { background: var(--g3); color: #020617; }

.calendar-wrap { overflow-x: auto; margin-top: 10px; }
table { border-collapse: collapse; }
.heat { width: 14px; height: 14px; border-radius: 3px; margin: 2px; }

.garden { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }
.plant { height: 60px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

.backup-zone { display: flex; gap: 8px; margin-top: 1rem; }
.backup-zone button { flex: 1; padding: 10px; font-size: 0.75rem; }
</style>
</head>
<body>

<main>
  <div class="control-panel">
    <div class="input-group">
      <input id="habitInput" placeholder="Add new habit...">
      <button class="btn-primary" onclick="addHabit()">Add</button>
    </div>
    <div class="date-row">
      <span style="font-size: 0.8rem; color: var(--muted)">Log for:</span>
      <input type="date" id="datePicker">
    </div>
  </div>

  <div class="card" id="habitList"></div>

  <div class="card">
    <strong>Journal</strong>
    <textarea id="journal" style="width:100%; margin-top:10px; height:80px" placeholder="Write here..."></textarea>
    <button style="width:100%; margin-top:10px" onclick="saveJournal()">Save Entry</button>
  </div>

  <div class="card">
    <strong>Garden</strong>
    <div id="garden" class="garden"></div>
    
    <div class="backup-zone">
      <button class="btn-outline" onclick="exportCSV()">ðŸ“¥ Export CSV</button>
      <button class="btn-outline" onclick="document.getElementById('fileInput').click()">ðŸ“¤ Import CSV</button>
    </div>
    <input type="file" id="fileInput" style="display:none" onchange="importCSV(event)" accept=".csv">
  </div>

  <div class="card">
    <strong>Activity</strong>
    <div id="monthly" class="calendar-wrap"></div>
  </div>
</main>

<script>
const dp = document.getElementById('datePicker');
dp.value = new Date().toISOString().slice(0, 10);

const load = () => JSON.parse(localStorage.getItem('habits') || '[]');
const save = h => localStorage.setItem('habits', JSON.stringify(h));

function addHabit() {
  const i = document.getElementById('habitInput');
  if (!i.value.trim()) return;
  const h = load();
  h.push({ name: i.value, done: [] });
  save(h); i.value = ''; render();
}

function toggle(i) {
  const h = load();
  const d = dp.value;
  const idx = h[i].done.indexOf(d);
  idx >= 0 ? h[i].done.splice(idx, 1) : h[i].done.push(d);
  save(h); render();
}

function render() {
  const h = load(); const d = dp.value;
  const hl = document.getElementById('habitList'); hl.innerHTML = '';
  document.getElementById('journal').value = localStorage.getItem('j-' + d) || '';
  
  h.forEach((x, i) => {
    const row = document.createElement('div'); row.className = 'habit';
    row.innerHTML = `<div>${x.name}</div>
      <div class="check ${x.done.includes(d)?'done':''}" onclick="toggle(${i})">${x.done.includes(d)?'âœ“':''}</div>`;
    hl.appendChild(row);
  });
  renderMonth(); renderGarden();
}

function renderMonth() {
  const h = load(); const c = document.getElementById('monthly');
  const sel = new Date(dp.value + 'T00:00:00');
  const y = sel.getFullYear(), m = sel.getMonth();
  const days = new Date(y, m + 1, 0).getDate();
  let t = '<table>';
  h.forEach(x => {
    t += '<tr>';
    for(let d=1; d<=days; d++) {
      const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      t += `<td><div class="heat" style="background:${x.done.includes(k)?'var(--g3)':'#1e293b'}"></div></td>`;
    }
    t += '</tr>';
  });
  c.innerHTML = t + '</table>';
}

function renderGarden() {
  const g = document.getElementById('garden'); g.innerHTML = '';
  load().forEach(x => {
    const count = x.done.length;
    const div = document.createElement('div'); div.className = 'plant';
    div.innerHTML = count > 10 ? 'ðŸŒ¸' : count > 0 ? 'ðŸŒ±' : 'ðŸ•³ï¸';
    g.appendChild(div);
  });
}

function saveJournal() { localStorage.setItem('j-'+dp.value, document.getElementById('journal').value); alert("Journal Saved"); }

// CSV BACKUP SYSTEM
function exportCSV() {
  const habits = load();
  let csv = "Type,Name,Date/Value,Content\n";
  
  // Export Habits
  habits.forEach(h => {
    h.done.forEach(date => {
      csv += `Habit,"${h.name}",${date},DONE\n`;
    });
  });

  // Export Journal
  Object.keys(localStorage).forEach(key => {
    if (key.startsWith('j-')) {
      const date = key.replace('j-', '');
      const content = localStorage.getItem(key).replace(/"/g, '""');
      csv += `Journal,,${date},"${content}"\n`;
    }
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `mind_garden_backup_${dp.value}.csv`;
  a.click();
}

function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const rows = e.target.result.split('\n').slice(1);
    const habits = [];
    
    rows.forEach(row => {
      const [type, name, date, content] = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      if (!type) return;
      const cleanName = name?.replace(/"/g, '');
      const cleanContent = content?.replace(/"/g, '');

      if (type.trim() === 'Habit') {
        let h = habits.find(x => x.name === cleanName);
        if (!h) { h = { name: cleanName, done: [] }; habits.push(h); }
        h.done.push(date.trim());
      } else if (type.trim() === 'Journal') {
        localStorage.setItem('j-' + date.trim(), cleanContent.trim());
      }
    });
    
    if (habits.length > 0) save(habits);
    alert("Import Complete!");
    render();
  };
  reader.readAsText(file);
}

dp.onchange = render;
render();
</script>
</body>
</html>
