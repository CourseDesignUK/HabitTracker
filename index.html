<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Mind Garden</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root {
  --bg: #020617; --card: #0f172a; --muted: #94a3b8;
  --g3: #22c55e; --red: #ef4444;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
  margin: 0; font-family: -apple-system, system-ui, sans-serif; 
  background: var(--bg); color: #fff; overflow-x: hidden;
}

#main-view {
  padding: env(safe-area-inset-top) 1rem env(safe-area-inset-bottom);
  max-width: 500px; margin: auto; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}

/* Box Breathing Overlay */
#breath-view {
  position: fixed; top: 0; left: -100%; width: 100%; height: 100%;
  background: radial-gradient(circle at center, #0f172a 0%, #020617 100%);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: left 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  z-index: 100;
}
#breath-view.active { left: 0; }

.breath-container { position: relative; width: 250px; height: 250px; display: flex; align-items: center; justify-content: center; }

.breath-circle {
  width: 180px; height: 180px; border: 4px solid var(--g3); border-radius: 50%;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: transform 4s linear;
  box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
}

.breath-label { font-size: 1.2rem; font-weight: bold; color: var(--g3); text-transform: uppercase; letter-spacing: 2px; }
.countdown { font-size: 2.5rem; font-weight: 800; color: #fff; margin-top: 5px; }

/* UI Cards */
.card { background: var(--card); border-radius: 20px; padding: 1.2rem; margin-bottom: 1rem; border: 1px solid #1f2937; }
.habit { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #1f2937; }
.habit-actions { display: flex; align-items: center; gap: 15px; }
.check { width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--g3); display: flex; align-items: center; justify-content: center; cursor: pointer; }
.check.done { background: var(--g3); color: #020617; }
.del-btn { color: var(--red); font-size: 0.8rem; opacity: 0.5; border: none; background: none; padding: 5px; }

/* Buttons & Inputs */
input, textarea, button { background: #0f172a; border: 1px solid #334155; border-radius: 12px; color: #fff; padding: 12px; font-size: 16px; }
.btn-primary { background: var(--g3); color: #020617; border: none; font-weight: 700; width: 80px; }
.btn-outline { background: transparent; border: 1px solid #334155; font-size: 0.8rem; padding: 10px; color: #fff; flex: 1; border-radius: 12px;}
.garden { display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; }
.plant { height: 60px; background: rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
</style>
</head>
<body>

<div id="breath-view">
    <p style="color: var(--muted); margin-bottom: 3rem;">‚Üê Swipe Left to Garden</p>
    <div class="breath-container">
        <div class="breath-circle" id="circle">
            <span class="breath-label" id="label">Prepare</span>
            <div class="countdown" id="count">...</div>
        </div>
    </div>
</div>

<main id="main-view">
  <div class="card" style="margin-top: 1rem; background: #1e293b;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span style="font-size: 0.8rem; color: var(--muted)">Log Date:</span>
      <input type="date" id="datePicker" style="border:none; padding:0; background:none;">
    </div>
  </div>

  <div class="card"><strong>Garden</strong><div id="garden" class="garden" style="margin-top: 10px;"></div></div>
  
  <div class="card" id="habitList"></div>

  <div class="card">
    <div style="display: flex; gap: 8px;">
      <input id="habitInput" placeholder="New habit..." style="flex:1">
      <button class="btn-primary" onclick="addHabit()">Add</button>
    </div>
  </div>

  <div class="card">
    <strong>Journal</strong>
    <textarea id="journal" style="width:100%; margin-top:10px; height:80px" placeholder="Thoughts..."></textarea>
    <button style="width:100%; margin-top:10px" onclick="saveJournal()">Save Entry</button>
  </div>

  <div class="card">
    <strong>Backup & Activity</strong>
    <div id="monthly" style="overflow-x: auto; margin-top: 10px; margin-bottom: 1.5rem;"></div>
    <div style="display: flex; gap: 8px;">
      <button class="btn-outline" onclick="exportToICloud()">üì• Save to iCloud</button>
      <button class="btn-outline" onclick="document.getElementById('fileInput').click()">üì§ Import</button>
    </div>
    <input type="file" id="fileInput" style="display:none" onchange="importCSV(event)" accept=".csv">
  </div>
</main>

<script>
const dp = document.getElementById('datePicker');
dp.value = new Date().toISOString().slice(0, 10);
const load = () => JSON.parse(localStorage.getItem('habits') || '[]');
const save = h => localStorage.setItem('habits', JSON.stringify(h));

// --- VIBRATION & BREATHING ---
let breathTimer, countTimer;
function startBreathing() {
    const label = document.getElementById('label'), circle = document.getElementById('circle'), countEl = document.getElementById('count');
    const steps = [{t:'Inhale', s:'scale(1.3)'},{t:'Hold', s:'scale(1.3)'},{t:'Exhale', s:'scale(0.7)'},{t:'Hold', s:'scale(0.7)'}];
    let step = 0, sec = 4;
    const update = () => {
        label.innerText = steps[step].t; circle.style.transform = steps[step].s;
        if(navigator.vibrate) navigator.vibrate(100);
    };
    update();
    breathTimer = setInterval(() => { step=(step+1)%4; sec=4; update(); }, 4000);
    countTimer = setInterval(() => { sec--; if(sec<=0) sec=4; countEl.innerText=sec; if(navigator.vibrate) navigator.vibrate(10); }, 1000);
}
function stopBreathing() { clearInterval(breathTimer); clearInterval(countTimer); }

// --- ICLOUD EXPORT ---
async function exportToICloud() {
    let csv = "Type,Name,Date,Content\n";
    load().forEach(h => h.done.forEach(d => csv += `Habit,"${h.name}",${d},DONE\n`));
    Object.keys(localStorage).filter(k=>k.startsWith('j-')).forEach(k=>csv+=`Journal,,${k.replace('j-','')},"${localStorage.getItem(k)}"\n`);
    
    const filename = `MindGarden_${dp.value}.csv`;
    const blob = new Blob([csv], { type: 'text/csv' });
    
    // Check if system sharing is available (iOS/Mobile Safari)
    if (navigator.canShare && navigator.share) {
        const file = new File([blob], filename, { type: 'text/csv' });
        try {
            await navigator.share({
                files: [file],
                title: 'Mind Garden Backup',
            });
        } catch (err) { console.log("Share failed", err); }
    } else {
        // Fallback for desktop
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
    }
}

// --- CORE APP ---
function addHabit() {
  const i = document.getElementById('habitInput');
  if (!i.value.trim()) return;
  const h = load(); h.push({ name: i.value, done: [] });
  save(h); i.value = ''; render();
}
function deleteHabit(idx) { if(confirm('Delete this habit?')) { const h = load(); h.splice(idx, 1); save(h); render(); } }
function toggle(i) {
  const h = load(); const d = dp.value;
  const idx = h[i].done.indexOf(d);
  idx >= 0 ? h[i].done.splice(idx, 1) : h[i].done.push(d);
  save(h); render();
}
function render() {
  const h = load(); const d = dp.value;
  const hl = document.getElementById('habitList'); hl.innerHTML = '';
  document.getElementById('journal').value = localStorage.getItem('j-' + d) || '';
  h.forEach((x, i) => {
    const row = document.createElement('div'); row.className = 'habit';
    row.innerHTML = `<div>${x.name}</div>
      <div class="habit-actions">
        <button class="del-btn" onclick="deleteHabit(${i})">‚úï</button>
        <div class="check ${x.done.includes(d)?'done':''}" onclick="toggle(${i})">${x.done.includes(d)?'‚úì':''}</div>
      </div>`;
    hl.appendChild(row);
  });
  renderMonth(); renderGarden();
}
function renderMonth() {
  const h = load(); const c = document.getElementById('monthly');
  const sel = new Date(dp.value + 'T00:00:00');
  const y = sel.getFullYear(), m = sel.getMonth(), days = new Date(y, m + 1, 0).getDate();
  let t = '<table style="border-collapse: collapse;">';
  h.forEach(x => {
    t += '<tr>';
    for(let d=1; d<=days; d++) {
      const k = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      t += `<td><div style="width:12px; height:12px; border-radius:2px; margin:2px; background:${x.done.includes(k)?'var(--g3)':'#1e293b'}"></div></td>`;
    }
    t += '</tr>';
  });
  c.innerHTML = t + '</table>';
}
function renderGarden() {
  const g = document.getElementById('garden'); g.innerHTML = '';
  load().forEach(x => {
    const div = document.createElement('div'); div.className = 'plant';
    div.innerHTML = x.done.length > 10 ? 'üå∏' : x.done.length > 0 ? 'üå±' : 'üï≥Ô∏è';
    g.appendChild(div);
  });
}
function saveJournal() { localStorage.setItem('j-'+dp.value, document.getElementById('journal').value); alert("Saved"); }
function importCSV(e) {
  const reader = new FileReader();
  reader.onload = (ev) => {
    const habits = [];
    ev.target.result.split('\n').slice(1).forEach(row => {
      const p = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      if (p.length < 3) return;
      if (p[0].trim()==='Habit') {
        let h = habits.find(x=>x.name===p[1].replace(/"/g,''));
        if (!h) { h={name:p[1].replace(/"/g,''),done:[]}; habits.push(h); }
        h.done.push(p[2].trim());
      } else { localStorage.setItem('j-'+p[2].trim(), p[3].replace(/"/g,'')); }
    });
    save(habits); render(); alert("Imported!");
  };
  reader.readAsText(e.target.files[0]);
}

let tStart = 0;
document.addEventListener('touchstart', e => tStart = e.changedTouches[0].screenX);
document.addEventListener('touchend', e => {
    let diff = e.changedTouches[0].screenX - tStart;
    const main = document.getElementById('main-view'), breath = document.getElementById('breath-view');
    if (diff > 100) { breath.classList.add('active'); main.style.transform = "translateX(100%)"; startBreathing(); }
    if (diff < -100) { breath.classList.remove('active'); main.style.transform = "translateX(0)"; stopBreathing(); }
});

dp.onchange = render;
render();
</script>
</body>
</html>
